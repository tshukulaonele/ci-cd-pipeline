name: CI/CD Pipeline

on:
  push:
    branches:
      - main  # Run on every push to the main branch
  pull_request:
    branches:
      - main  # Run on every pull request to the main branch

jobs:
  # Step 1: Build Stage
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v2

      - name: Set up Node.js
        uses: actions/setup-node@v2
        with:
          node-version: '14'  # Specify Node.js version

      - name: Install dependencies
        run: npm install

      - name: Build project
        run: npm run build

      - name: Upload artifacts
        uses: actions/upload-artifact@v2
        with:
          name: build-artifact
          path: ./dist  # Specify path to build artifacts

  # Step 2: Test Stage
  test:
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: Checkout code
        uses: actions/checkout@v2

      - name: Set up Node.js
        uses: actions/setup-node@v2
        with:
          node-version: '14'

      - name: Install dependencies
        run: npm install

      - name: Run tests
        run: npm test

      - name: Run code coverage
        run: npm run coverage

      - name: Run code quality checks
        run: npm run lint  # Example for linting (code analysis)

  # Step 3: Deploy Stage
  deploy:
    runs-on: ubuntu-latest
    needs: test
    if: github.ref == 'refs/heads/main'  # Only deploy on pushes to the main branch
    steps:
      - name: Checkout code
        uses: actions/checkout@v2

      - name: Download artifacts
        uses: actions/download-artifact@v2
        with:
          name: build-artifact
          path: ./dist

      - name: Deploy to staging
        env:
          AZURE_WEBAPP_NAME: 'your-staging-webapp-name'
          AZURE_RESOURCE_GROUP: 'your-resource-group'
          AZURE_SUBSCRIPTION_ID: 'your-subscription-id'
          AZURE_CREDENTIALS: ${{ secrets.AZURE_CREDENTIALS }}
        run: |
          # Login to Azure
          echo "${AZURE_CREDENTIALS}" > "$HOME/azure-credentials.json"
          az login --service-principal --username $(jq -r '.clientId' "$HOME/azure-credentials.json") \
            --password $(jq -r '.clientSecret' "$HOME/azure-credentials.json") \
            --tenant $(jq -r '.tenantId' "$HOME/azure-credentials.json")

          # Deploy to Azure Web App
          az webapp deployment source config-zip \
            --resource-group ${AZURE_RESOURCE_GROUP} \
            --name ${AZURE_WEBAPP_NAME} \
            --src ./dist
